@section Styles{
    <link rel="stylesheet" href="~/css/Case/UpdateCase.css" asp-append-version="true" />
}
    @{
    var caseData = Newtonsoft.Json.JsonConvert.SerializeObject(@Model);
}
<section id="updatetCase">
    <div class="container mt-5" id="msgSuccessSubmit">
        <form id="updateCaseForm" class="needs-validation " enctype="multipart/form-data">
            <div class="row pt-3">
                <div class="col-12">
                    <h4 class="postTitle mb-2">修改貼文</h4>
                    <h6>說明</h6>
                </div>
                <div class="col-12 mb-3">
                    <label for="CaseTitle" class="form-label">標題</label>
                    <input type="text" class="form-control" v-bind:class="{'is-invalid':titleValid}"
                           id="CaseTitle" name="CaseTitle" v-model="title" placeholder="請輸入標題" required>
                    <div class="invalid-feedback">
                        請輸入標題
                    </div>
                </div>
                <div class="col-md-5 mb-2">
                    <label for="CaseNeedHelp" class="form-label">貼文分類</label>
                    <select class="form-select" id="CaseNeedHelp" v-model="CaseNeedHelp" v-bind:class="{'is-invalid':isneedValid}" required>
                        <option selected="selected" value="default" disabled>請選擇</option>
                        <option value=true>需要幫助</option>
                        <option value=false>提供技能</option>
                    </select>
                    <div class="invalid-feedback">
                        請選擇「技能」或「需求」
                    </div>
                </div>
                <div class="col-md-7">
                    <label for="CaseSkilId" class="form-label">內容</label>
                    <select class="form-select" id="CaseSkilId" name="CaseSkilId" v-model="CaseSkilId" v-bind:class="{'is-invalid':skillIdValid}" required>
                        <option selected="selected" value="default" disabled>請選擇</option>
                        <option v-for="item in skillTags" v-bind:value="item.skillId">{{item.skillName}}</option>
                    </select>
                    <div class="invalid-feedback">
                        請選擇內容分類
                    </div>
                </div>
                <div class="col-12 mb-3">
                    <label for="CaseTitle" class="form-label">交易點數(請輸入數字)</label>
                    <input type="text" class="form-control" v-bind:class="{'is-invalid':pointValid}"
                           id="CasePoint" name="CasePoint" v-model.number="point" v-on:keypress="isNumber"
                           maxlength="5" required>
                    <div class="invalid-feedback">
                        超過持有點數
                    </div>
                </div>
                <div class="col-12 mb-3 mt-3">
                    <label for="CaseIntroduction" class="form-label">說明</label>
                    <textarea class="form-control" v-model="intro" v-bind:class="{'is-invalid':introValid}"
                              id="CaseIntroduction" name="CaseIntroduction" cols="30" rows="5"
                              placeholder="請簡述需求或技能內容" required></textarea>
                    <div class="invalid-feedback">
                        此欄位不可為空
                    </div>
                </div>
                <div class="col-12">
                    <label for="CasePhoto" class="form-label">圖片(大小請勿超過2MB)</label>
                    <input type="file" class="form-control" id="CasePhoto" name="CasePhoto" onchange="previewPic(this)"
                           accept="image/*" required>
                    <img id="pic" src=@Model.CasePhoto>
                </div>
                <hr class="my-4">
                <h6>地區</h6>
                <div class="col-md-7 mb-2">
                    <label for="AreaCity" class="form-label">縣市</label>
                    <select class="form-select" id="AreaCity" v-on:change="getAreaTown" v-model="CaseCity" required>
                        <option selected="selected" disabled>請選擇</option>
                        <option v-for="item in areaCity" v-bind:value="item">{{item}}</option>
                    </select>
                </div>
                <div class="col-md-5 mb-2">
                    <label for="CaseSerArea" class="form-label">鄉鎮區</label>
                    <select class="form-select" id="CaseSerArea" name="CaseSerArea" v-model="CaseSerArea"
                            v-bind:class="{'is-invalid':serAreaValid}" required>
                        @*<option v-show="isAreaSelected" value="default" selected="selected" disabled>請先選擇縣市</option>*@
                        <option v-for="item in areaTown" :value="item.AreaId">{{item.AreaTown}}</option>
                    </select>
                    <div class="invalid-feedback">
                        請選擇地區
                    </div>
                </div>
                <div class="col-12">
                    <label for="CaseSerDate" class="form-label">可接受服務或提供技能的時間</label>
                    <textarea class="form-control" v-model="CaseSerDate" v-bind:class="{'is-invalid':serDateValid}"
                              id="CaseSerDate" name="CaseSerDate" placeholder="請輸入日期或時段"
                              cols="30" rows="2" required></textarea>
                    <div class="invalid-feedback">
                        此欄位不可為空
                    </div>
                </div>
                <hr class="my-4">
                <h6 id="releaseTitle">發佈時間</h6>
                <div id="releaseOption" class="col-12">
                    <input type="radio" name="postTime" id="timeNow" v-on:change="disableDate" checked>
                    <label for="timeNow">立即發佈</label>
                    <br>
                    <input type="radio" name="postTime" id="timeAppointment" v-on:change="ableDate">
                    <label for="timeAppointment">預約發佈</label>
                    <br>
                    <input type="date" id="CaseReleaseDate" name="CaseReleaseDate" v-on:change="updateDateRemind">
                </div>

                <p id="dateP">貼文自動下架時間為 <span id="dateRemind"></span></p>

                <div class="col-12 text-center">
                    <button class="postBtn w-25 mt-4" type="button" v-on:click="sumbitCase">送出</button>
                </div>
        </form>
    </div>
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1000">
        <div id="ToastTransResult" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fa-solid fa-bell"></i>
                <strong class="me-auto">&nbsp;通知</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Oops...修改失敗
            </div>
        </div>
    </div>
</section>


@section Scripts{
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        var userPoint = @Html.Raw(ViewBag.UserPoint);
        var caseModel = @Html.Raw(caseData);
        var vmUpCase = new Vue({
            el: "#updatetCase",
            data: {
                updateCase: caseModel,
                areaCity: [],
                areaTown: [],
                skillTags: [],
                userPoint: userPoint,
                title: caseModel.CaseTitle,
                intro: caseModel.CaseIntroduction,
                CaseSerDate: caseModel.CaseSerDate,
                CaseCity: caseModel.CaseCity,
                CaseSerArea: caseModel.CaseSerArea,
                CaseNeedHelp: caseModel.CaseNeedHelp,
                CaseSkilId: caseModel.CaseSkilId,
                point: caseModel.CasePoint,
                titleValid: false,
                isneedValid: false,
                skillIdValid: false,
                pointValid: false,
                introValid: false,
                serAreaValid: false,
                serDateValid: false
            },
            methods: {
                getAreaCity: function() {
                    $.ajax({
                        url: "/Nav/_LayoutApi/GetAreaCity",
                        type: "GET"
                    }).
                        done(function(res) {
                            vmUpCase.areaCity = res;
                        })
                        .fail(function(res) {
                            console.log(res);
                        });
                },
                getAreaTown: function(e) {
                    var SelectedCity = "";
                    if (typeof (e) == "string") {
                        SelectedCity = e;
                    }
                    else {
                        SelectedCity = e.target.value;
                    }
                    $.ajax({
                        url: "/Nav/_LayoutApi/GetAreaTownWithId",
                        type: "GET",
                        data: {
                            AreaCity: SelectedCity
                        }
                    }).
                        done(function(res) {
                            vmUpCase.areaTown = JSON.parse(res);
                            if (typeof (e) != "string") {
                                setTimeout(() => {
                                    var CaseSerArea = document.getElementById("CaseSerArea");
                                    CaseSerArea.options[1].selected = true;
                                    vmUpCase.CaseSerArea = parseInt(CaseSerArea.options[1].value);
                                }, 100);
                            }
                        })
                        .fail(function(res) {
                            console.log(res);
                        });
                },
                getSkillTags: function() {
                    $.ajax({
                        url: "/Case/GetSkillTags",
                        type: "POST",
                    }).done(function(res) {
                        vmUpCase.skillTags = res;
                    })
                        .fail(function(res) {
                            console.log(res);
                        });
                },
                isNumber: function(e) {
                    if ((charCode > 31 && (charCode < 48 || charCode > 57)) && charCode !== 46) {
                        e.preventDefault();
                    } else {
                        return true;
                    }
                },
                updateDateRemind: function() {
                    var dateRemind = document.getElementById("dateRemind");
                    dateRemind.innerText = this.finalDate(CaseReleaseDate.value, 14);
                },
                disableDate: function() {
                    var CaseReleaseDate = document.getElementById("CaseReleaseDate");
                    CaseReleaseDate.setAttribute('disabled', 'disabled');
                    CaseReleaseDate.value = this.getDateString(new Date());//時間恢復為當天
                    dateRemind.innerText = this.finalDate(new Date(), 14);//預告下架日期
                },
                ableDate: function() {
                    var CaseReleaseDate = document.getElementById("CaseReleaseDate");
                    CaseReleaseDate.removeAttribute('disabled');
                },
                getDateString: function(date) {
                    let monthJs = date.getMonth();
                    let monthMd = (monthJs + 1) < 10 ? `0${monthJs + 1}` : monthJs + 1 > 12 ? monthJs : monthJs + 1;
                    let dateJs = date.getDate();
                    let dateMd = dateJs < 10 ? `0${dateJs}` : dateJs;
                    return `${date.getFullYear()}-${monthMd}-${dateMd}`;
                },
                finalDate: function(dateBegin, intCounts) {
                    let selectedTimeStamp = new Date(dateBegin).getTime();
                    let resultTimeStamp = selectedTimeStamp + intCounts * 1000 * 60 * 60 * 24;
                    let finalDay = new Date(resultTimeStamp);
                    return vmUpCase.getDateString(finalDay);
                },
                scrollToElement: function(strElementId) {
                    var elePos = $(`#${strElementId}`).offset().top;
                    $(window).scrollTop(elePos - 200);
                },
                sumbitCase: function(e) {
                    //valid
                    var validFail = [];
                    if (this.title == "") {
                        this.titleValid = true;
                        validFail.push("CaseTitle");
                    }
                    if (this.CaseNeedHelp == "default") {
                        this.isneedValid = true;
                        validFail.push("CaseNeedHelp");
                    }
                    if (this.CaseSkilId == "default") {
                        this.skillIdValid = true;
                        validFail.push("CaseSkilId");
                    }
                    if (this.point > this.userPoint) {
                        this.pointValid = true;
                        validFail.push("CasePoint");
                    }
                    if (this.intro == "") {
                        this.introValid = true;
                        validFail.push("CaseIntroduction");
                    }
                    if (this.CaseSerArea == "default") {
                        this.serAreaValid = true;
                        validFail.push("CaseSerArea");
                    }
                    if (this.CaseSerDate == "") {
                        this.serDateValid = true;
                        validFail.push("CaseSerDate");
                    }
                    if (validFail.length != 0) {
                        this.scrollToElement(validFail[0]);
                        return;
                    }
                    //submit
                    e.preventDefault();
                    var caseForm = $("form")[0];
                    var formData = new FormData(caseForm);
                    formData.append("CaseId", this.updateCase.CaseId);
                    formData.append("CaseTitle", $("#CaseTitle").val());
                    formData.append("CaseNeedHelp", $("#CaseNeedHelp").val());
                    formData.append("CaseSkilId", $("#CaseSkilId").val());
                    formData.append("CaseTitle", $("#CaseTitle").val());
                    formData.append("CasePoint", $("#CasePoint").val());
                    formData.append("CaseIntroduction", $("#CaseIntroduction").val());
                    if (pic.src != this.updateCase.CasePhoto) formData.append("CasePhoto", $("#CasePhoto").prop("files")[0]);
                    formData.append("CaseSerArea", $("#CaseSerArea").val());
                    formData.append("CaseSerDate", $("#CaseSerDate").val());
                    formData.append("CaseReleaseDate", $("#CaseReleaseDate").val());
                    $.ajax({
                        url: "/Case/CaseUpdateSave",
                        type: "POST",
                        data: formData,
                        async: false,
                        cache: false,
                        contentType: false,
                        enctype: 'multipart/form-data',
                        processData: false,
                    }).done(function(res) {
                        $("#msgSuccessSubmit").html("<div id='successAdd'><div class='text-center m-2'><i class='mb-3 fa-solid fa-paper-plane' style='font-size: 50px;'></i> <h4 class='fw-500 mb-0'>修改成功</h4> <p class='fw-300 fs-14'>可至「我的技能與需求」查看</p><a class='btn btn-primary m-1 text-white' href='/Home/ProfilePageAjax?page=myCase'>查看</a></div></div>");
                        window.scrollTo(0, 0);
                    })
                        .fail(function(res) {
                            var toastTransResult = document.getElementById("ToastTransResult")
                            var toast = new bootstrap.Toast(toastTransResult);
                            toast.show();
                        });
                    return false;
                }
            },
            watch: {
                title: function(e) {
                    if (e.length > 0) this.titleValid = false;
                },
                CaseNeedHelp: function(e) {
                    if (e != "dafault") this.isneedValid = false;
                },
                CaseSkilId: function(e) {
                    if (e != "dafault") this.skillIdValid = false;
                },
                point: function(e) {
                    this.pointValid = e > this.userPoint ? true : false;
                },
                intro: function(e) {
                    if (e.length > 0) this.introValid = false;
                },
                CaseSerArea: function(e) {
                    if (e != "dafault") this.serAreaValid = false;
                },
                CaseSerDate: function(e) {
                    if (e.length > 0) this.serDateValid = false;
                }
            },
            mounted: function() {
                this.getAreaCity();
                this.getAreaTown(this.CaseCity);
                this.getSkillTags();
                var releaseDate = new Date(this.updateCase.CaseRealseDate)
                if (releaseDate < new Date()) {
                    $("#releaseOption input[type='radio']").prop("disabled", true);
                    document.getElementById("releaseTitle").innerText = "貼文已發佈，無法變更時間";
                }
                this.$nextTick(() => {
                    var currentDate = new Date();
                    var CaseReleaseDate = document.getElementById("CaseReleaseDate");
                    var dateRemind = document.getElementById("dateRemind");
                    CaseReleaseDate.min = CaseReleaseDate.value = this.getDateString(currentDate);
                    CaseReleaseDate.max = this.finalDate(currentDate, 14);
                    dateRemind.innerText = CaseReleaseDate.max;
                    CaseReleaseDate.setAttribute('disabled', 'disabled');
                });
            }
        });
        function previewPic(e) {
            var maxSize = 2 * 1024 * 1024;
            if (e.files[0].size > maxSize) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: '圖片大小請勿超過2MB',
                    footer: ''
                });
            }
            else {
                pic.src = URL.createObjectURL(e.files[0])
            }
        }
    </script>
        }