@model MutualBank.Models.PostPageVM

@{
    ViewData["Title"] = "Index";
}
@section Styles
    {
    <link rel="stylesheet" href="~/css/postpage.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/postpageTmp.css" asp-append-version="true" />

}

    <main class="container">
        <div class="postpage container-fluid">
            <div class="page-top">
                <div class="page-title"> @Html.DisplayFor(Model=>Model.CaseTitle) </div>
                <div calss="need">@Html.DisplayFor(Model=>Model.SkillName)</div>
            </div>
            <!-- 圖片與資訊 -->
            <div class="page-botton">
                <!-- 圖片 -->
                <div class="author-pic">
                    <div class="pic-frame">
                        <img src="@Html.DisplayFor(Model=>Model.CasePhoto)" alt="無此圖片">
                    </div>
                </div>
                <!-- 資訊 -->
                <div class="author">
                    <span class="author-pic-name">
                        <span class="authorpicture-frame">
                            <img src="@Html.DisplayFor(model=>model.UserPhoto)" alt="" onerror="this.src = 'https://i.pinimg.com/564x/31/1e/34/311e34183aa017d0dd4b232a8a5f3cd8.jpg';this.onerror = null" class="author-picture">
                        </span>
                        <span class="author-name">
                            <h2 href="" style="padding-left:20px; font-size:16px" class="authorname">@Html.DisplayFor(Model=>Model.UserNName)</h2>
                        </span>
                    </span>
                    <div class="author-itemlist">
                        <div calss="post-time">
                            <span>
                                <i class="fa-regular fa-calendar"></i>
                            </span>
                            <span style="padding-left:6px;">建立日期：<span>@Html.DisplayFor(Model=>Model.CasesAddDate)</span></span>
                        </div>
                        <div calss="need-time">
                            <span>
                                <i class="fa-regular fa-clock"></i>
                            </span>
                            <span style="padding-left:3px ">需求時間：<span>@Html.DisplayFor(Model=>Model.CaseSerDate)</span></span>
                        </div>
                        <div calss="need-location">
                            <span>
                                <i class="fa-solid fa-location-dot"></i>
                            </span>
                            <span style="padding-left:5px ">地點：<span>@Html.DisplayFor(Model=>Model.Areacity)@Html.DisplayFor(Model=>Model.AreaTownname)</span></span>
                        </div>
                    </div>
                    <div id="confirmCase">
                        <div class="mt-4">
                            @*TODO if(案件為未交易 且登入者為po文擁有者才顯示)*@
                            <button v-if="isWaitForTrans" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#listModal">
                                選擇交易對象
                            </button>
                            <button v-else type="button" class="btn btn-outline-primary" title="可至個人頁點選結案" disabled>
                                案件執行中
                            </button>
                        </div>
                        <!-- confirm modal (targetlist) -->
                        <div class="modal fade" id="listModal"
                         tabindex="-1" aria-labelledby="listModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered" v-bind:class={"modal-dialog-scrollable":isModalNeedScroll}>
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLabel">選擇交易對象</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body text-nowrap p-0">
                                        <ul class="selectList p-0 m-0" v-if="isPostHasMsg">
                                            <li class="d-flex justify-content-start userItem" name="userItem"
                                            :data-userid="item.UserId" :data-username="item.UserName"
                                            v-for="item in msgUserModel" v-on:click="selectUser">
                                                <input type="radio" name="inpUser" class="m-3 pe-none"
                                                   :value="item.UserName" style="width:20px;">
                                                <div class="userPhotoBx pe-none">
                                                    <img class="pe-none" src="https://i.pinimg.com/564x/31/1e/34/311e34183aa017d0dd4b232a8a5f3cd8.jpg">
                                                </div>
                                                <label class="m-auto ms-2 pe-none">{{item.UserName}}</label>
                                            </li>
                                        </ul>
                                        <span v-else class="m-3 ms-5 fw-300">還沒有人留言</span>
                                    </div>
                                    <div class="modal-footer">
                                        <div class="me-0">
                                            <label>點數：</label>
                                            <input :disabled="!isPostHasMsg" class="me-2 inputPoint" type="text" maxlength="3"
                                               v-model.number="finalPoint" title="請設定要交易的點數">
                                            <button :disabled="!isPostHasMsg" v-on:click="resetPoint" type="button" class="btn btn-primary">重設</button>
                                        </div>
                                        @*<div class="">
                                            <label class="fs-14">請輸入數字！</label>
                                            <label class="fs-14">請勿超過持有點數</label>
                                        </div>*@
                                        <div>
                                            <span v-show="isPostHasMsg" class="me-2">將與<strong>&nbsp;{{selectedUser}}&nbsp;</strong>交易<strong>&nbsp;{{finalPoint}}&nbsp;</strong>點</span>
                                            <button :disabled="!isPostHasMsg" type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                            <button :disabled="!isPostHasMsg" v-on:click="modalBeBelow" type="button"
                                                id="btnSelectTarget" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmModal">
                                                確認
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- confirm modal 2 -->
                        <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLabel">確認交易</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body text-center fs-18">
                                        確定要選擇<span class="btn selectedUser fs-18">&nbsp;{{selectedUser}}&nbsp;</span>，並交易<strong>&nbsp;{{finalPoint}}&nbsp;</strong>點嗎？
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                        <button type="button" class="btn btn-primary" :data-targetid="selectedUserId" v-on:click="savePointTransLog">確認</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 介紹 -->
            <div calss="atricle-content-frame">
                <div class="article-contnt-title">
                    <span>簡介</span>
                </div>
                <div class="article-content">
                    <span class="article">@Html.DisplayFor(Model=>Model.CaseIntroduction)</span>
                </div>
            </div>
            <!-- 留言板 -->
            <div class="messageboard-frame" id="postpage">
                <div class="messageboard-title"> 留言</div>
                <!-- 輸入訊息 -->
                <form asp-action="AddComment" asp-controller="PostPage">
                    <div class="comment-frame">
                        <div>
                            <div class="user-pic">
                                <img src="@Html.DisplayFor(model=>model.LoginHPhoto)" alt="" onerror="this.src = 'https://i.pinimg.com/564x/31/1e/34/311e34183aa017d0dd4b232a8a5f3cd8.jpg';this.onerror = null" class="author-picture">
                            </div>
                        </div>

                        <div class="textarea-box">
                            <textarea type="text" class="form-control" id="exampleFormControlTextarea1" placeholder="請輸入你的訊息"
                                  maxlength="200" rows="3" name="content" v-model="value"></textarea>
                            <div class="statics-text"><span>{{wordvalue}}</span>/200字</div>
                        </div>
                        <div class="col-auto">
                            <input type="button" class="btn btn-primary" id="commentbtn" disabled data-caseid="@Model.CaseId" value="留言" v-on:click="addcoment" />
                        </div>

                    </div>
                </form>
                <div id="message">

                    <!-- 回應爸爸 -->
                    <div class="respone-mes-frame" v-for="item in msglist">
                        <div class="responer-pic">
                            <a href="">
                                <div class="pad-avatar">
                                    <img src="{{item.magUserPhoto}}" alt="" onerror="this.src='https://i.pinimg.com/564x/31/1e/34/311e34183aa017d0dd4b232a8a5f3cd8.jpg';this.onerror = null" class="respons-picture">
                                </div>
                            </a>
                        </div>

                        <div class="pad-content">
                            <div class="responser-name-frame">
                                <div class="responser-name">{{item.msgUserName}}</div>
                                <span class="comment-id" hidden>{{item.msgId}}</span>
                                <span class="responser-name-id" hidden>{{item.msgUserId}}</span>
                            </div>
                            <div class="responser-context">
                                <div class="text">
                                    {{item.msgContent}}
                                </div>
                            </div>
                            <div class="response-day-button">
                                <i class="fa-regular fa-clock"></i>
                                <span class="post-time">留言日期：{{item.msgAddDate|showDate}}</span>
                                <input type="button" class="replay-btn" v-on:click="recommentre" value="回覆" />

                            </div>
                            <!-- 回應小孩 -->
                            <div class="comment-bother-frame" v-for="x in item.mychildinhouse">
                                <div class="comment-bother">
                                    <a href="" class="comment-pic-frame">
                                        <div style="width: 24px; height: 24px;" class="avatar-frame">
                                            <img src="{{x.childtoUserHphoto}}" alt="" onerror="this.src='https://i.pinimg.com/564x/31/1e/34/311e34183aa017d0dd4b232a8a5f3cd8.jpg';this.onerror = null" class="comment-bother-pic">
                                        </div>
                                    </a>
                                    <div class="comment-brother-re">
                                        <div class="responser-name-frame">
                                            <a class="responser-name" href="">{{x.childname}}</a>
                                            <div class="reply-user">
                                                <span>回覆給：<span>{{x.childtoUsername}}</span></span>
                                                <div class="comment-bother">
                                                    <a href="">
                                                        <img src="{{x.childHphoto}}" alt="" onerror="this.src='https://i.pinimg.com/564x/31/1e/34/311e34183aa017d0dd4b232a8a5f3cd8.jpg';this.onerror = null" class="comment-bother-pic">
                                                    </a>
                                                </div>
                                            </div>

                                        </div>
                                        <div class="text">{{x.childcontent}}</div>
                                        <div class="response-day-button">
                                            <i class="fa-regular fa-clock"></i>
                                            <span class="post-time">留言日期：{{x.childaddDate|showDate}}</span>
                                            <input type="button" class="replay-btn" v-on:click="recommentreboy" value="回覆" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 回應訊息輸入 -->
                            <form asp-action='AddreComment' asp-controller='PostPage' id="comment-bother-frame-input-top" class="comment-bother-frame-input-top" hidden>
                                <div class='comment-bother-frame-input'>
                                    <span id='comment-id' name="parentid" hidden></span>
                                    <span id='comment-touser-id' name="touserid" hidden></span>
                                    <div class='comment-bother-input'>
                                        <div class='textarea-box'>
                                            <textarea type='text' class='form-control responeenter' id='exampleFormControlTextarea2' maxlength='200' rows='3' name="content" v-model="valuecd"></textarea>
                                            <div class='statics-text'><span>{{wordvaluecd}}</span>/200字</div>
                                        </div>
                                        <div class='col-auto-input'>
                                            <input type='button' class='btn btn-primary' data-bs-toggle='button' id='commentbtmre' value='留言' v-on:click="addrecomment" />
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>





    @section Scripts
    {

    <script>
        var caseId = @Model.CaseId;
        var isExecute = @Json.Serialize(Model.IsExecute);
        var vmPoint = new Vue({
            el: "#confirmCase",
            data: {
                msgUserModel: [],
                isWaitForTrans: !isExecute,
                selectedUser: "User",
                selectedUserId: "",
                orginPoint:0,
                finalPoint: 0
            },
            methods: {
                getMsgUserModel: function() {
                    fetch("/PostPageTmp/getMsgUserModel/" + caseId)
                        .then(res => { return res.json() })
                        .then(data => {
                            var obj = JSON.parse(data)
                            vmPoint.msgUserModel = obj;
                            vmPoint.finalPoint = vmPoint.orginPoint = obj[0].CasePoint;
                            //vmPoint.selectedUser = obj[0].UserName;
                        })
                        .catch(err => console.log(err))
                },
                selectUser: function(e) {
                    var userItem = document.getElementsByName("userItem");
                    var inpUser = document.getElementsByName("inpUser");
                    inpUser.forEach(x => x.removeAttribute("checked"));
                    userItem.forEach(x => x.classList.remove("active"));
                    e.target.classList.add("active");
                    e.target.childNodes[0].checked = true;
                    this.selectedUser = e.target.dataset.username;
                    this.selectedUserId=e.target.dataset.userid;
                },
                modalBeBelow: function() {
                    var modalBackdrop = document.querySelector(".modal-backdrop.fade.show");
                    modalBackdrop.style.zIndex = 1049;
                    var listModal = document.getElementById("listModal");
                    listModal.style.zIndex = 1050;
                },
                savePointTransLog: function() {
                    fetch("/PostPageTmp/savePointTransLog", {
                        method: 'POST',
                        body: JSON.stringify({ CaseId: caseId, CasePoint: vmPoint.finalPoint, TargetUserId: 1 }),
                        headers: { 'Content-Type': 'application/json' }
                    })
                        .then(res => {
                            if (res.status == 200 & res.ok == true) {
                                $("#listModal").modal("hide");
                                $("#confirmModal").modal("hide");
                                vmPoint.isWaitForTrans = false;
                            }
                        })
                        .catch(res => console.log(res))
                },
                resetPoint: function() {
                    this.finalPoint = this.orginPoint;
                }
            },
            computed: {
                isModalNeedScroll: function() {
                    return this.msgUserModel.length > 4 ? true : false;
                },
                isPostHasMsg: function() {
                    return this.msgUserModel.length > 0 ? true : false;
                }
            },
            created: function() {
                this.getMsgUserModel();
            }
        });

        var msgData = @Html.Raw(ViewBag.tmessages);
        let PP = new Vue({
            el: "#postpage",
            data: {
                msglist: msgData,
                value:"",
                valuecd:"",


            },

            filters: {
                showDate: function(e) {
                    if (e.includes("T")) {
                        return e.split("T")[0];
                    }
                }
            },

            methods: {
                addcoment: function() {
                    var id = document.getElementById("commentbtn").dataset.caseid;
                    var formData = new FormData();
                    formData.append("id", id);
                    formData.append("content", $("#exampleFormControlTextarea1").val());
                    $.ajax({
                        url: "/PostPage/AddComment",
                        type: "POST",
                        data: formData,
                        async: false,
                        cache: false,
                        contentType: false,
                        processData: false,
                        success: function(res) {
                            alert("新增成功");
                            PP.msglist.push(res)
                            $("textarea:eq(0)").val("");
                            $("#commentbtn").attr("disabled", "true");
                            var targetTop = $(".respone-mes-frame").last().offset().top;
                            $(window).scrollTop(targetTop);

                        },
                        error: function(res) {
                            alert("新增失敗")
                        }
                    });
                },
                recommentre: function(e) {
                    $(e.target).parents(".response-day-button").siblings("#comment-bother-frame-input-top").removeAttr("hidden")
                    var tousername = $(e.target).parents(".response-day-button").siblings(".responser-name-frame").children(".responser-name").text()
                    var touserid = $(e.target).parents(".response-day-button").siblings(".responser-name-frame").children(".responser-name-id").text()
                    var commentid = $(e.target).parents(".response-day-button").siblings(".responser-name-frame").children(".comment-id").text()


                    $(".responeenter").attr("placeholder", "回覆給：" + tousername)
                    $("#comment-touser-id").text(touserid)
                    $("#comment-id").text(commentid)

                    //if ($(".textarea-box").length == 1 & b.length >= 1) {

                    //    $(".form-control").attr("placeholder", "回覆給：" + tousername)
                    //    $("#comment-touser-id").text(touserid)
                    //    $("#comment-id").text(commentid)
                    //};

                },
                recommentreboy: function(e) { 
                  $(e.target).parents(".comment-bother-frame").siblings("#comment-bother-frame-input-top").removeAttr("hidden")
                  var tousername = $(e.target).parents(".response-day-button").siblings(".responser-name-frame").children(".responser-name").text()
                  var touserid = $(e.target).parents(".response-day-button").siblings(".responser-name-frame").children(".responser-name-id").text()
                  var commentid = $(e.target).parents(".response-day-button").siblings(".responser-name-frame").children(".comment-id").text()

                  $(".responeenter").attr("placeholder", "回覆給：" + tousername)
                    $("#comment-touser-id").text(touserid)
                    $("#comment-id").text(commentid)

                },
                addrecomment: function(e) {
                    var id = $("#commentbtn").data("caseid");
                    var textval = $(e.target).parents(".col-auto-input").siblings(".textarea-box").children(".responeenter").val()
                    var formData = new FormData();
                    formData.append("id", id);
                    formData.append("content", textval);
                    formData.append("parentid", $("#comment-id").text());
                    formData.append("touserid", $("#comment-touser-id").text());
                    var y = $("#comment-id").text(); 
                    $.ajax({
                        url: "/PostPage/AddreComment",
                        type: "POST",
                        data: formData,
                        async: false,
                        cache: false,
                        contentType: false,
                        processData: false,
                        success: function(res) {
                            alert("新增成功");
                            var msglistindex = PP.msglist.findIndex(x => x.msgId == y)
                            PP.msglist[msglistindex].mychildinhouse.push(res)
                            $(".comment-bother-frame-input-top").attr("hidden","hidden")
                        },
                        error: function(res) {
                            alert("新增失敗");
                        },
                    });
                },

            },

            computed: {
                wordvalue: function() {   
                    return this.value.length;
                },
                wordvaluecd: function() {   
                    return this.valuecd.length;
                },

            },

        })

       


    </script>

    <script src="~/js/PostPage.js"></script>
}
